<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏</title>
  <link rel="stylesheet" href="/assets/site.css">
</head>
<body>
<div class="container">
  <div id="nav"></div>

  <div class="panel">
    <h2>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h2>

    <div class="grid" style="margin-bottom:14px">
      <div class="col-6">
        <div class="panel" style="padding:14px">
          <h2 style="margin-bottom:8px">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
          <p style="margin:0;color:var(--muted)">
            –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–µ–±—É—é—Ç JWT (—Ä–æ–ª—å user/admin). –í–æ–π–¥–∏, —á—Ç–æ–±—ã POST/DELETE —à–ª–∏ —Å Bearer.
          </p>

          <form id="loginForm" style="margin-top:12px">
            <div class="field">
              <label>Email</label>
              <input name="email" placeholder="user@local" value="user@local" required />
            </div>
            <div class="field">
              <label>–ü–∞—Ä–æ–ª—å</label>
              <input name="password" type="password" placeholder="User123$" value="User123$" required />
            </div>
            <div class="btns">
              <button type="submit">–í–æ–π—Ç–∏</button>
              <button type="button" class="secondary" id="logoutBtn">–í—ã–π—Ç–∏</button>
            </div>
            <div class="toast" id="authStatus"></div>
          </form>
        </div>
      </div>

      <div class="col-6">
        <div class="panel" style="padding:14px">
          <h2 style="margin-bottom:8px">–ü—Ä–∞–≤–∏–ª–∞</h2>
          <p style="margin:0;color:var(--muted)">
            –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤ –ø–∞–º—è—Ç–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ 50 –∑–∞–ø–∏—Å—è–º–∏. –§–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ <code>wwwroot/uploads</code>.
          </p>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="col-6">
        <form id="uploadForm">
          <div class="field">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
            <input name="title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ–æ–≥–æ—Ç–∏–ø –∫–æ–º–ø–∞–Ω–∏–∏" required />
          </div>
          <div class="field">
            <label>–§–∞–π–ª (JPG/PNG/WEBP), –¥–æ 5 –ú–ë</label>
            <input type="file" name="file" accept="image/jpeg,image/png,image/webp" required />
          </div>
          <div class="btns">
            <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
            <button type="button" class="secondary" id="refresh">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
          </div>
          <div class="toast" id="status"></div>
        </form>
      </div>

      <div class="col-6">
        <div class="panel" style="padding:14px">
          <h2 style="margin-bottom:8px">–ü–æ–¥—Å–∫–∞–∑–∫–∞</h2>
          <p style="margin:0;color:var(--muted)">
            –ï—Å–ª–∏ –≤–∏–¥–∏—à—å 401/403 ‚Äî –≤–æ–π–¥–∏. –ï—Å–ª–∏ 405 ‚Äî —Å–º–æ—Ç—Ä–∏ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∞–ª–µ—Ä—Ç–µ (Allow + –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞).
          </p>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ</h2>
    <div id="cards" class="cards"></div>
  </div>
</div>

<script src="/assets/auth.js"></script>

<script>
async function loadNav(){
  const r = await fetch('/pages/_nav.html');
  document.getElementById('nav').innerHTML = await r.text();
}

function setStatus(text){
  document.getElementById('status').textContent = text || '';
}

function setAuthStatus(text){
  document.getElementById('authStatus').textContent = text || '';
}

function hasToken(){
  return !!(window.auth && window.auth.getToken && window.auth.getToken());
}

function renderAuthState(){
  setAuthStatus(hasToken() ? '–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω. POST/DELETE –∫ /api/ –±—É–¥—É—Ç —Å Authorization.' : '–¢–æ–∫–µ–Ω–∞ –Ω–µ—Ç. –ù–∞–∂–º–∏ ¬´–í–æ–π—Ç–∏¬ª.');
}

async function readTextSafe(res){
  try { return await res.text(); } catch { return ''; }
}

function showHttpError(prefix, res, body){
  const allow = res.headers ? (res.headers.get('Allow') || '') : '';
  const msg =
    prefix + ': ' + res.status +
    (allow ? ('\\nAllow: ' + allow) : '') +
    (body ? ('\\n' + body) : '');
  alert(msg);
}

async function refresh(){
  const r = await fetch('/api/images?page=1&pageSize=12');
  const data = await r.json();

  const wrap = document.getElementById('cards');
  wrap.innerHTML = '';

  const items = data.items || [];
  if(!items.length){
    wrap.innerHTML = '<div class="badge">–ü–æ–∫–∞ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤–æ–µ.</div>';
    return;
  }

  items.forEach(x => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <img class="thumb" src="${x.url}" alt="">
      <div class="card-body">
        <div class="row">
          <p class="title">${x.title}</p>
          <span class="badge">–†–µ–π—Ç–∏–Ω–≥: ${x.score}</span>
        </div>
        <div class="meta">üëç ${x.likes} &nbsp;&nbsp; üëé ${x.dislikes}</div>
        <div class="btns">
          <button class="danger" data-id="${x.id}">–£–¥–∞–ª–∏—Ç—å</button>
          <button class="secondary" onclick="window.open('${x.url}','_blank')">–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª</button>
        </div>
      </div>
    `;
    wrap.appendChild(card);
  });

  wrap.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-id');

      try{
        const res = await apiFetch('/api/images/' + id, { method:'DELETE' });

        if(res.status === 401 || res.status === 403){
          alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ (—Ä–æ–ª—å user/admin).');
          return;
        }

        if(res.status===204) refresh();
        else{
          const body = await readTextSafe(res);
          showHttpError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', res, body);
        }
      }catch(e){
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (e && e.message ? e.message : e));
      }
    });
  });
}

document.getElementById('uploadForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  setStatus('–ó–∞–≥—Ä—É–∑–∫–∞...');

  const fd = new FormData(e.target);

  try{
    const res = await apiFetch('/api/images/upload', { method:'POST', body: fd });

    if(res.status===401 || res.status===403){
      setStatus('');
      alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ (—Ä–æ–ª—å user/admin).');
      return;
    }

    if(res.status===201){
      e.target.reset();
      setStatus('–ì–æ—Ç–æ–≤–æ: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ.');
      refresh();
      return;
    }

    const body = await readTextSafe(res);
    setStatus('');
    showHttpError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', res, body);
  }catch(err){
    setStatus('');
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (err && err.message ? err.message : err));
  }
});

document.getElementById('refresh').addEventListener('click', refresh);

document.getElementById('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  setAuthStatus('–í—Ö–æ–¥...');

  const fd = new FormData(e.target);
  const email = String(fd.get('email') || '').trim();
  const password = String(fd.get('password') || '');

  try{
    await window.auth.login(email, password);
    renderAuthState();
  }catch(err){
    setAuthStatus('');
    alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (err && err.message ? err.message : err));
  }
});

document.getElementById('logoutBtn').addEventListener('click', ()=>{
  window.auth.setToken('');
  renderAuthState();
});

loadNav().then(()=>{
  renderAuthState();
  refresh();
});
</script>
</body>
</html>
